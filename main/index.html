<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>Charger controller</title>
</head>

<style>
body {
  background-color: #111;
  font: 1.2rem sans-serif;
}
.buttonOff { /* https://habr.com/ru/articles/860704/ https://habr.com/ru/companies/netologyru/articles/655337/ */
  background-color: transparent; /* button has animated rectangle beyond, added by .buttonOff::before */
  border-radius: 1rem;
  border: 2px solid #764abc;
  padding: 0.5rem 1rem;
  position: relative;
  color: #764abc;
  font: 1.2rem 'Open Sans', Helvetica, Arial, sans-serif;
  cursor: default;
  overflow: hidden;
}
.buttonOff::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: #0cf;
  z-index: -1;
}
.buttonOff:active { /* onButtonClick - run 0s animation "longClick" with start delay 3s, .onanimationend = longPressEvent */
  animation-name: "longClick"; 
  animation-delay: 3s;
  animation-fill-mode: forwards;
}
.buttonOff:active::before { /* onButtonClick - start 3s width transition on rectangle under button */
  transition: width 3s linear;
  width: 0%;
}
.buttonOff:not(:hover) { /* stop animation "longClick" if cursor moved from button */
  animation-play-state: paused;
}
.buttonOff:not(:hover)::before { /* reset size of rectangle under button if cursor moved from button */
  transition: width 0s linear;
  width: 100%;
}
@keyframes longClick {
  to {
    pointer-events: none; /* click event disable */
  }
}
.buttonOn {
  background-color: transparent;
  border-radius: 1rem;
  border: 2px solid #764abc;
  padding: 0.5rem 1rem;
  position: relative;
  color: #764abc;
  font: 1.2rem 'Open Sans', Helvetica, Arial, sans-serif;
  cursor: default;
  overflow: hidden;
}
.buttonOn::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 0%;
  height: 100%;
  background-color: #0cf;
  z-index: -1;
}
.buttonOn:active {
  animation-name: "longClick"; 
  animation-delay: 3s;
  animation-fill-mode: forwards;
}
.buttonOn:active::before {
  transition: width 3s linear;
  width: 100%;
}
.buttonOn:not(:hover) {
  animation-play-state: paused;
}
.buttonOn:not(:hover)::before {
  transition: width 0s linear;
  width: 0%;
}

.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place for top */
  z-index: 11; /* Sit on top */
  left: 0; /* Use full window */
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
  text-align: center;
}
.modal-content {
  width: 60%;
  position: relative;
  top: 5%;
  background-color: #fefefe;
  font: 1.5rem 'Open Sans', Helvetica, Arial, sans-serif;
  margin: 0% auto; /* 0% from the top and centered */
  padding: 0px;
  border: 1px solid #888;
  animation: fadein 0.5s;
}
.modal-header {
  padding: 2px 5px;
  background-color: #5cb85c;
}
.modal-body {
  margin: 15px;
  overflow-y: auto;
  max-height: 75vh;
}
.modal-body input {
  font: 1.5rem 'Open Sans', Helvetica, Arial, sans-serif;
  width: 10rem;
}
.modal-body button, p {
  font: 1.5rem 'Open Sans', Helvetica, Arial, sans-serif;
  margin: 5px;
}

@keyframes fadein {
  from { top: -5%; opacity: 0; }
  to   { top: 5%; opacity: 1; }
}

.closebtn {
  color: black;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}

.closebtn:hover,
.closebtn:focus {
  color: white;
} 

.alert {
  display: none; /* Hidden by default */
  z-index: 12; /* above modal */
  position: absolute;
  margin-left: auto;
  margin-right: auto;
  left: 0;
  right: 0;
  padding: 25px 40px;
  width: 60%;
  background-color: #f44336;
  color: white;
  font: 1.5rem 'Open Sans', Helvetica, Arial, sans-serif;
  top: 5%;
  animation: fadein 0.5s;
}

.closebtn:hover {
    color: black;
}
.header {
  display: flex;
  font: 1.5rem 'Open Sans', Helvetica, Arial, sans-serif;
  height: 80px;
}
.header button {
  background-color: transparent;
  border-radius: 1rem;
  border: 2px solid #764abc;
  padding: 0.5rem 1rem;
  margin: auto 1% auto 0;
  font: 1.2rem 'Open Sans', Helvetica, Arial, sans-serif;
  color: #764abc;
}
.header p {
  margin: auto 1% auto 0;
  color: #888;
}
.header span {
  color: SeaGreen;
  text-decoration: underline;
}

.container {
  display: none; /* Hidden by default. Used table */
  width: 100%;
  height: 350px;
  color: white;
}
.container span {
  color: hotpink;
  font-weight: 600;
}
.chart {
  display: table-cell;
  background: black;
  width: 1400px;
  height: 350px;
}

.logcontainer {
  display: table;
  margin: 1% 0;
  width: 100%;
  height: 350px;
  color: white;
}
textarea {
  width: inherit;
  height: inherit;
  box-sizing: border-box;
  resize: none;
  font-size: 1.2rem;
  font-weight: 600;
  background-color: black;
  color: green;
}
table {
  width: 100%;
  font: 1.2rem 'Open Sans', Helvetica, Arial, sans-serif;
}
td {
  width: 100%;
  white-space:nowrap;
}
</style>

<body>
    <div id="alert" class="alert">
        <span class="closebtn" onclick="javascript:this.parentElement.style.display='none';">&times;</span> 
        <div id="alertMsg"></div>
    </div>
    <div class="header">
        <p style="color:#FFF;">Charger controller</p>
        <p id="controllerTime">-</p>
        <p id="chargerLimits">-</p>
        <p>Relay turn on at <span id="chargerTurnOnTime">--:--</span>, turn off at <span id="chargerTurnOffTime">--:--</span>.</p>
        <button onclick="javascript:openConfigModal();">Modify</button>
        <button id="relayState" class="buttonOn" style="margin: auto 1% auto auto;">Turn on AC mains</button>
    </div>
    <hr>

    <!-- charger0 container, clone div block up to charger15 -->
    <div class="container" id="container0">
        <table>
        <tr><td>Charger SN : <span id="chargerSN0">-</span></td><td rowspan="13"><canvas class="chart" id="charger0"></canvas></td></tr>
        <tr><td>Charger status : <span id="chargerStatus0">-</span></td></tr>
        <tr><td>Charger alarms : <span id="chargerAlarms0">-</span></td></tr>
        <tr><td>Charger warnings : <span id="chargerWarnings0">-</span></td></tr>
        <tr><td>Charger inlet temperature : <span id="chargerInTemp0">-</span>C</td></tr>
        <tr><td>Charger outlet temperature : <span id="chargerOutTemp0">-</span>C</td></tr>
        <tr><td>AC Voltage : <span id="acVoltage0">-</span>V</td></tr>
        <tr><td>DC Voltage : <span id="dcVoltage0">-</span>V</td></tr>
        <tr><td>DC Current : <span id="dcCurrent0">-</span>A</td></tr>
        <tr><td>Charger model : <span id="chargerName0">-</span></td></tr>
        <tr><td>Charger HW version : <span title="Test" id="chargerHWVer0">-</span></td></tr>
        <tr><td>Charger SW version : <span title="Test" id="chargerSWVer0">-</span></td></tr>
        <tr><td>Charger SW version spare : <span title="Test" id="chargerSWVerSpare0">-</span></td></tr>
        </table>
        <hr>
    </div>
    <div class="container" id="container1">
        <table>
        <tr><td>Charger SN : <span id="chargerSN1">-</span></td><td rowspan="13"><canvas class="chart" id="charger1"></canvas></td></tr>
        <tr><td>Charger status : <span id="chargerStatus1">-</span></td></tr>
        <tr><td>Charger alarms : <span id="chargerAlarms1">-</span></td></tr>
        <tr><td>Charger warnings : <span id="chargerWarnings1">-</span></td></tr>
        <tr><td>Charger inlet temperature : <span id="chargerInTemp1">-</span>C</td></tr>
        <tr><td>Charger outlet temperature : <span id="chargerOutTemp1">-</span>C</td></tr>
        <tr><td>AC Voltage : <span id="acVoltage1">-</span>V</td></tr>
        <tr><td>DC Voltage : <span id="dcVoltage1">-</span>V</td></tr>
        <tr><td>DC Current : <span id="dcCurrent1">-</span>A</td></tr>
        <tr><td>Charger model : <span id="chargerName1">-</span></td></tr>
        <tr><td>Charger HW version : <span title="Test" id="chargerHWVer1">-</span></td></tr>
        <tr><td>Charger SW version : <span title="Test" id="chargerSWVer1">-</span></td></tr>
        <tr><td>Charger SW version spare : <span title="Test" id="chargerSWVerSpare1">-</span></td></tr>
        </table>
        <hr>
    </div>
    <div class="container" id="container2">
        <table>
        <tr><td>Charger SN : <span id="chargerSN2">-</span></td><td rowspan="13"><canvas class="chart" id="charger2"></canvas></td></tr>
        <tr><td>Charger status : <span id="chargerStatus2">-</span></td></tr>
        <tr><td>Charger alarms : <span id="chargerAlarms2">-</span></td></tr>
        <tr><td>Charger warnings : <span id="chargerWarnings2">-</span></td></tr>
        <tr><td>Charger inlet temperature : <span id="chargerInTemp2">-</span>C</td></tr>
        <tr><td>Charger outlet temperature : <span id="chargerOutTemp2">-</span>C</td></tr>
        <tr><td>AC Voltage : <span id="acVoltage2">-</span>V</td></tr>
        <tr><td>DC Voltage : <span id="dcVoltage2">-</span>V</td></tr>
        <tr><td>DC Current : <span id="dcCurrent2">-</span>A</td></tr>
        <tr><td>Charger model : <span id="chargerName2">-</span></td></tr>
        <tr><td>Charger HW version : <span title="Test" id="chargerHWVer2">-</span></td></tr>
        <tr><td>Charger SW version : <span title="Test" id="chargerSWVer2">-</span></td></tr>
        <tr><td>Charger SW version spare : <span title="Test" id="chargerSWVerSpare2">-</span></td></tr>
        </table>
        <hr>
    </div>
    <div class="container" id="container3">
        <table>
        <tr><td>Charger SN : <span id="chargerSN3">-</span></td><td rowspan="13"><canvas class="chart" id="charger1"></canvas></td></tr>
        <tr><td>Charger status : <span id="chargerStatus3">-</span></td></tr>
        <tr><td>Charger alarms : <span id="chargerAlarms3">-</span></td></tr>
        <tr><td>Charger warnings : <span id="chargerWarnings3">-</span></td></tr>
        <tr><td>Charger inlet temperature : <span id="chargerInTemp3">-</span>C</td></tr>
        <tr><td>Charger outlet temperature : <span id="chargerOutTemp3">-</span>C</td></tr>
        <tr><td>AC Voltage : <span id="acVoltage3">-</span>V</td></tr>
        <tr><td>DC Voltage : <span id="dcVoltage3">-</span>V</td></tr>
        <tr><td>DC Current : <span id="dcCurrent3">-</span>A</td></tr>
        <tr><td>Charger model : <span id="chargerName3">-</span></td></tr>
        <tr><td>Charger HW version : <span title="Test" id="chargerHWVer3">-</span></td></tr>
        <tr><td>Charger SW version : <span title="Test" id="chargerSWVer3">-</span></td></tr>
        <tr><td>Charger SW version spare : <span title="Test" id="chargerSWVerSpare3">-</span></td></tr>
        </table>
        <hr>
    </div>

    <div class="logcontainer">
        <textarea id="log" readonly></textarea>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="closebtn" onclick="javascript:closeConfigModal();">&times;</span>
                <h3>Modify Settings. <span style="color: red;">Use with care.</span></h3>
            </div>
            <div class="modal-body">
                <p>Enable or disable limits for all chargers.</p>
                <input type="checkbox" id="applyLimits" style="width: auto;">
                <label for="applyLimits">Apply limits</label>
                <button class="confButton" onclick="javascript:applyLimits();">Set parameter</button>
                <br>
                <p>Current limit (10.0A - 37.4A). This current value will be sent to chargers if limits are active.</p>
                <input type="text" id="dcCurrent" maxlength="10" placeholder="37.4">
                <button class="confButton" onclick="javascript:setCurrentLimit();">Set parameter</button>
                <br>
                <p>Voltage limit (41.60V - 58.20V).  This voltage value will be sent to chargers if limits are active.</p>
                <input type="text" id="dcVoltage" maxlength="10" placeholder="53.5">
                <button class="confButton" onclick="javascript:setVoltageLimit();">Set parameter</button>
                <br>
                <p>Chargers mains turn on time (00:01 - 23:59). Time when the relay is turned on.</p>
                <input type="text" id="turnOnTime" maxlength="10" placeholder="23:15">
                <button class="confButton" onclick="javascript:setRelayTurnOnTime();">Set parameter</button>
                <br>
                <p>Chargers mains turn off time (00:01 - 23:59). Time when the relay is turned off.</p>
                <input type="text" id="turnOffTime" maxlength="10" placeholder="6:45">
                <button class="confButton" onclick="javascript:setRelayTurnOffTime();">Set parameter</button>
                <br>
                <p>Write controller configuration to flash. Configuration is loaded from flash when controller is powered on.</p>
                <button class="confButton" onclick="javascript:storeConfigToNVS();">Save configuration</button>
                <hr>
                <p>Set charger default voltage at power on (41.60V - 58.20V).</p>
                <input type="text" id="dcVoltageDefault" maxlength="10" placeholder="53.5">
                <button class="confButton" onclick="javascript:setDefaultVoltage();">Set parameter</button>
                <hr>
                <button onclick="javascript:closeConfigModal();">Close</button>
            </div>
        </div>
    </div>
</body>

<script>
    // pixl-chart v1.0.8 - (c) 2024 Joseph Huckaby <jhuckaby@gmail.com> - MIT License - https://github.com/jhuckaby/pixl-chart
    class Chart{constructor(t={}){this.events={},this.canvas=null,this.layers=[],this.colors=["#008FFB","#00E396","#FEB019","#FF4560","#775DD0","#3F51B5","#4CAF50","#546E7A","#D4526E","#A5978B","#C7F464","#81D4FA","#2B908F","#F9A3A4","#90EE7E","#FA4443","#449DD1","#F86624","#69D2E7","#EA3546","#662E9B","#C5D86D","#D7263D","#1B998B","#2E294E","#F46036","#E2C044","#662E9B","#F86624","#F9C80E","#EA3546","#43BCCD","#5C4742","#A5978B","#8D5B4C","#5A2A27","#C4BBAF","#A300D6","#7D02EB","#5653FE","#2983FF","#00B1F2","#03A9F4","#33B2DF","#4ECDC4","#13D8AA","#FD6A6A","#F9CE1D","#FF9800"],this.background="",this.fontFamily="Helvetica, sans-serif",this.fontSize=12,this.fontColor="rgb(128, 128, 128)",this.titleSize=16,this.titleStyle="bold",this.titlePadding=15,this.title="",this.subtitle="",this.showSubtitle=!0,this.lineWidth=2,this.lineJoin="round",this.lineCap="butt",this.lineDashes=!1,this.stroke=!0,this.fill=.5,this.clip=!1,this.horizTicks=6,this.vertTicks=6,this.vertLabelPadding=10,this.horizLabelPadding=25,this.borderColor="rgba(128, 128, 128, 0.25)",this.density=window.devicePixelRatio||1,this.autoResize=!0,this.autoManage=!0,this.dataType="integer",this.dataSuffix="",this.floatPrecision=2,this.legend=!0,this.legendMaxLines=2,this.legendPadding=5,this.zeroFloor=!0,this.smoothing=!0,this.smoothingMaxSamples=200,this.hover=!0,this.hoverSort=0,this.cursor="crosshair",this.showDataGaps=!1,this.dataGapImage="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAAAnOwc2AAAAAXNSR0IArs4c6QAAADRJREFUCNedyjERAEEQAsERsjpwhQUK6Z9cRvZpVxNXPQDoVXHMUsxSxdJrvwmWeixVLMUfKik183saHHcAAAAASUVORK5CYII=",this.autoHeadroom=!0,this.padding={left:0,top:0,right:10,bottom:0},this.zoom=null,this.width=0,this.height=0,this.progressive=!1,this.delta=!1,this.dirty=!1,this.hidden=!1;var e,i=Intl.DateTimeFormat().resolvedOptions();for(e in this.locale=i.locale,this.timeZone=i.timeZone,this.dateStyles={minute:{hour:"numeric",hour12:!1,minute:"2-digit",second:"2-digit"},hour:{hour:"numeric",hour12:!0,minute:"2-digit"},day:{hour:"numeric",hour12:!0},month:{month:"short",day:"numeric"},year:{month:"short"},tooltip:{year:"numeric",month:"short",day:"numeric",hour:"numeric",hour12:!0,minute:"2-digit"}},t)this[e]=t[e];this.padding.left=this.padding.left||0,this.padding.top=this.padding.top||0,this.padding.right=this.padding.right||0,this.padding.bottom=this.padding.bottom||0,this.init()}clone(t={}){var e=Object.assign({},this);return delete e.canvas,delete e.ctx,delete e.dirty,delete e.bounds,delete e.observer,delete e.events,delete e.tooltip,delete e.manager,delete e.idx,"colors"in t||(e.colors=JSON.parse(JSON.stringify(e.colors))),"dateStyles"in t||(e.dateStyles=JSON.parse(JSON.stringify(e.dateStyles))),"padding"in t||(e.padding=JSON.parse(JSON.stringify(e.padding))),new Chart(Object.assign(e,t))}init(){var t;this.layers.length&&(t=this.layers,this.layers=[],this.addLayers(t)),"string"==typeof this.canvas&&(this.canvas=document.querySelector(this.canvas)),this.ctx=this.canvas.getContext("2d"),this.cursor&&(this.canvas.style.cursor=this.cursor),this.autoResize&&this.setupObserver(),this.autoManage&&(ChartManager.inited||ChartManager.init(),ChartManager.add(this)),this.hover&&this.setupHover(),this.showDataGaps&&!this.gapPattern?this.setupDataGaps():this.ready=!0}setupObserver(){var t=this,e=!0;this.observer=new ResizeObserver(function(){e?e=!1:t.dirty=!0}),this.observer.observe(this.canvas)}addLayer(t){var e=Object.assign({},t);if(e.data=JSON.parse(JSON.stringify(t.data||[])),e.idx=this.layers.length,e.color=e.color||this.colors[e.idx%this.colors.length],e.data.length&&(Array.isArray(e.data[0])&&(e.data=e.data.map(function(t){return{x:t[0],y:t[1]}})),"string"==typeof e.data[0].x?e.data.forEach(function(t){t.x=new Date(t.x).getTime()/1e3}):9999999999<e.data[0].x&&e.data.forEach(function(t){t.x/=1e3}),(e.offsetX||e.offsetY)&&e.data.forEach(function(t){t.x+=e.offsetX||0,t.y+=e.offsetY||0}),this.delta)){for(var i=e.data.length-1;1<=i;i--)e.data[i].y-=e.data[i-1].y,this.divideByDelta&&(e.data[i].y/=e.data[i].x-e.data[i-1].x);e.data[0].y=0}this.layers.push(e),this.dirty=!0}addLayers(t){var e=this;t.forEach(function(t){e.addLayer(t)}),this.dirty=!0}render(){this.ready&&(this.width&&this.height?(this.canvas.width=this.width*this.density,this.canvas.height=this.height*this.density):this.autoResize&&(this.canvas.width=this.canvas.offsetWidth*this.density,this.canvas.height=this.canvas.offsetHeight*this.density),this.draw(),this.redrawTooltip(),this.dirty=!1,this.emit("render"))}draw(){var t=this.padding,e=Math.ceil(this.canvas.width/this.density),i=Math.ceil(this.canvas.height/this.density);this.ctx.clearRect(0,0,e,i),this.background&&(this.ctx.save(),this.ctx.fillStyle=this.background,this.ctx.fillRect(0,0,e,i),this.ctx.restore()),this.bounds={x:0+t.left,y:0+t.top,width:e-(t.left+t.right),height:i-(t.top+t.bottom)},this.locateDataLimits(),this.renderTitle(),this.renderLegend(),this.renderVertAxis(),this.renderHorizAxis(),this.renderDataGaps(),this.renderData()}locateDataLimits(){var h={xMin:null,yMin:null,xMax:null,yMax:null};this.zoom?h=this.zoom:this.layers.forEach(function(t){if(!t.hidden)for(var e,i,a=t.data,s=0,o=a.length;s<o;s++)e=a[s].x,i=a[s].y,(null===h.xMin||e<h.xMin)&&(h.xMin=e),(null===h.xMax||e>h.xMax)&&(h.xMax=e),(null===h.yMin||i<h.yMin)&&(h.yMin=i),(null===h.yMax||i>h.yMax)&&(h.yMax=i)}),this.dataLimits=h,this.zeroFloor&&(null===h.yMin||0<h.yMin)&&(h.yMin=0),h.yMax||(h.yMax=1),h.yMin==h.yMax&&h.yMin--,h.xMin&&h.xMax||(h.xMax=Math.floor(Date.now()/1e3),h.xMin=h.xMax-1),h.xMin==h.xMax&&h.xMin--,this.autoHeadroom&&this.addHeadroom(),this.minHorizScale&&h.xMax-h.xMin<this.minHorizScale&&(h.xMax=h.xMin+this.minHorizScale),this.minVertScale&&h.yMax-h.yMin<this.minVertScale&&(h.yMax=h.yMin+this.minVertScale),h.width=h.xMax-h.xMin,h.height=h.yMax-h.yMin;var t=h.xMax-h.xMin,e="",e=2764800<t?"year":172800<t?"month":43200<t?"day":120<t?"hour":"minute";this.dateRange=e}addHeadroom(){var t=this.dataLimits;if(!(t.yMax<=0))switch(this.dataType){case"bytes":t.yMax=Math.ceil(t.yMax),t.yMax<1024?(t.yMax<10?7<=t.yMax&&(t.yMax=10):(15<t.yMax&&(t.yMax=10*Math.ceil(t.yMax/10)),150<t.yMax&&(t.yMax=100*Math.ceil(t.yMax/100))),1024<t.yMax&&(t.yMax=1024)):(1536<t.yMax&&(t.yMax=1024*Math.ceil(t.yMax/1024)),15360<t.yMax&&(t.yMax=10240*Math.ceil(t.yMax/10240)),153600<t.yMax&&(t.yMax=102400*Math.ceil(t.yMax/102400)),1572864<t.yMax&&(t.yMax=1048576*Math.ceil(t.yMax/1048576)),15728640<t.yMax&&(t.yMax=10485760*Math.ceil(t.yMax/10485760)),157286400<t.yMax&&(t.yMax=104857600*Math.ceil(t.yMax/104857600)),1610612736<t.yMax&&(t.yMax=1073741824*Math.ceil(t.yMax/1073741824)),16106127360<t.yMax&&(t.yMax=10737418240*Math.ceil(t.yMax/10737418240)),161061273600<t.yMax&&(t.yMax=107374182400*Math.ceil(t.yMax/107374182400)),1649267441664<t.yMax&&(t.yMax=1099511627776*Math.ceil(t.yMax/1099511627776)));break;case"seconds":t.yMax=Math.ceil(t.yMax),t.yMax<60?(t.yMax<10?7<=t.yMax&&(t.yMax=10):15<t.yMax&&(t.yMax=10*Math.ceil(t.yMax/10)),60<t.yMax&&(t.yMax=60)):t.yMax<3600?(t.yMax=60*Math.ceil(t.yMax/60),900<t.yMax&&(t.yMax=600*Math.ceil(t.yMax/600))):t.yMax<86400?t.yMax=3600*Math.ceil(t.yMax/3600):t.yMax=86400*Math.ceil(t.yMax/86400);break;case"milliseconds":t.yMax<.1?(.015<t.yMax&&(t.yMax=Math.ceil(100*t.yMax)/100),.07<=t.yMax&&(t.yMax=.1)):t.yMax<1?(.15<t.yMax&&(t.yMax=Math.ceil(10*t.yMax)/10),.7<=t.yMax&&(t.yMax=1)):t.yMax<10?(t.yMax=Math.ceil(t.yMax),7<=t.yMax&&(t.yMax=10)):(t.yMax=Math.ceil(t.yMax),15<t.yMax&&(t.yMax=10*Math.ceil(t.yMax/10)),150<t.yMax&&(t.yMax=100*Math.ceil(t.yMax/100)),1e3<=t.yMax&&(t.yMax=1e3*Math.ceil(t.yMax/1e3),t.yMax<6e4?(t.yMax<1e4?7e3<=t.yMax&&(t.yMax=1e4):15e3<t.yMax&&(t.yMax=1e4*Math.ceil(t.yMax/1e4)),6e4<t.yMax&&(t.yMax=6e4)):t.yMax<36e5?(t.yMax=6e4*Math.ceil(t.yMax/6e4),9e5<t.yMax&&(t.yMax=6e5*Math.ceil(t.yMax/6e5))):t.yMax<864e5?t.yMax=36e5*Math.ceil(t.yMax/36e5):t.yMax=864e5*Math.ceil(t.yMax/864e5)));break;case"integer":case"float":t.yMax<.1?(.015<t.yMax&&(t.yMax=Math.ceil(100*t.yMax)/100),.07<=t.yMax&&(t.yMax=.1)):t.yMax<1?(.15<t.yMax&&(t.yMax=Math.ceil(10*t.yMax)/10),.7<=t.yMax&&(t.yMax=1)):t.yMax<10?(t.yMax=Math.ceil(t.yMax),7<=t.yMax&&(t.yMax=10)):(t.yMax=Math.ceil(t.yMax),15<t.yMax&&(t.yMax=10*Math.ceil(t.yMax/10)),150<t.yMax&&(t.yMax=100*Math.ceil(t.yMax/100)),1500<t.yMax&&(t.yMax=1e3*Math.ceil(t.yMax/1e3)),15e3<t.yMax&&(t.yMax=1e4*Math.ceil(t.yMax/1e4)),15e4<t.yMax&&(t.yMax=1e5*Math.ceil(t.yMax/1e5)),15e5<t.yMax&&(t.yMax=1e6*Math.ceil(t.yMax/1e6)),15e6<t.yMax&&(t.yMax=1e7*Math.ceil(t.yMax/1e7)),15e7<t.yMax&&(t.yMax=1e8*Math.ceil(t.yMax/1e8)))}}renderVertAxis(){var t=this.ctx,e=this.dataLimits,i=this.bounds;i.height-=this.horizLabelPadding+this.fontSize,t.save(),t.scale(this.density,this.density),t.font="normal "+this.fontSize+"px "+this.fontFamily,t.textAlign="left",t.textBaseline="middle",t.fillStyle=this.fontColor,t.strokeStyle=this.borderColor;for(var a=[],s=0,o=0;o<=this.vertTicks;o++){var h=e.yMin+(e.yMax-e.yMin)/this.vertTicks*o,r=this.formatDataValue(h,this.dataType,this.dataSuffix),l=t.measureText(r);l.width>s&&(s=l.width);var n=i.y+i.height-o/this.vertTicks*i.height;a.push({text:r,info:l,y:n,value:h})}for(var d={},c=!1,o=0,x=a.length;o<x;o++)(y=a[o]).text in d&&(c=!0),d[y.text]=1;i.width-=s+2*this.vertLabelPadding,i.x+=s+2*this.vertLabelPadding;for(o=0,x=a.length;o<x;o++){var y=a[o];t.beginPath(),t.moveTo(i.x,y.y),t.lineTo(i.x+i.width,y.y),t.stroke(),0!=o&&o!=x-1&&c||t.fillText(y.text,i.x-y.info.width-this.vertLabelPadding,y.y)}t.restore()}renderHorizAxis(){var t=this.ctx,e=this.dataLimits,i=this.bounds;t.save(),t.scale(this.density,this.density),t.font="normal "+this.fontSize+"px "+this.fontFamily,t.textAlign="center",t.textBaseline="top",t.fillStyle=this.fontColor,t.strokeStyle=this.borderColor;for(var a=[],s=this.dateRange,o=0;o<this.horizTicks;o++){var h=e.xMin+(e.xMax-e.xMin)/this.horizTicks*o,r=this.formatDate(h,s),h=i.x+o/this.horizTicks*i.width;a.push({text:r,x:h})}for(var o=0,l=a.length;o<l;o++){var n=a[o];0<o&&(t.beginPath(),t.moveTo(n.x,i.y),t.lineTo(n.x,i.y+i.height+8),t.stroke()),o&&n.text==a[o-1].text||t.fillText(n.text,n.x,i.y+i.height+12)}t.restore()}renderTitle(){var t=this.ctx,e=this.bounds;this.title.length&&(t.save(),t.scale(this.density,this.density),t.font=this.titleStyle+" "+this.titleSize+"px "+this.fontFamily,t.textAlign="center",t.fillStyle=this.fontColor,t.textBaseline="middle",this.showSubtitle?(t.fillText(this.title,e.x+e.width/2,e.y+this.titlePadding),t.font="normal "+this.fontSize+"px "+this.fontFamily,t.fillText(this.getSubtitle(),e.x+e.width/2,e.y+ +this.titleSize+this.titlePadding+1)):t.fillText(this.title,e.x+e.width/2,e.y+this.titleSize/2+this.titlePadding),t.restore(),e.y+=this.titleSize+2*this.titlePadding,e.height-=this.titleSize+2*this.titlePadding)}getSubtitle(){var t=this.dataLimits,e="";if(this.subtitle)return this.subtitle;switch(this.dateRange){case"minute":case"hour":case"day":e=(i=this.formatDate(t.xMin,"tooltip"))==(a=this.formatDate(t.xMax,"tooltip"))?i:i+" - "+this.formatDate(t.xMax,"hour");break;case"month":case"year":var i,a,s=Object.assign({},this.dateStyles.tooltip);delete s.minute,delete s.hour,delete s.hour12,e=(i=this.formatDate(t.xMin,s))==(a=this.formatDate(t.xMax,s))?i:i+" - "+a}return e}renderLegend(){var a,e,i,t,s,o,h=this,r=[],l=this.ctx,n=this.bounds;this.legend&&(l.save(),l.scale(this.density,this.density),l.font="normal "+this.fontSize+"px "+this.fontFamily,l.textAlign="left",l.fillStyle=this.fontColor,l.textBaseline="middle",a=null,this.layers.forEach(function(t){var e,i;t.hidden||(i=(e=l.measureText(t.title)).width+26,(!a||a.width+i>n.width)&&(a&&r.push(a),a={width:0,items:[]}),a.width+=i,a.items.push({layer:t,title:t.title,width:i,info:e}))}),a&&r.push(a),!r.length||r.length>this.legendMaxLines?l.restore():(e=this.fontSize+4,i=Math.floor(e/2),t=r.length*e+this.legendPadding,s=0,o=n.y+n.height-t,r.forEach(function(t){s=Math.floor(n.x+n.width/2-t.width/2),t.items.forEach(function(t){l.globalAlpha="opacity"in t.layer?t.layer.opacity:1,l.fillStyle=t.layer.color,l.beginPath(),l.arc(s+i,o+i,h.fontSize/2,0,2*Math.PI),l.fill(),l.fillStyle=h.fontColor,l.fillText(t.title,s+17,o+i),s+=t.width}),o+=e}),l.restore(),n.height-=t))}renderData(){this.hoverPoints={},this.dataLabels=[],this.isSmooth=!0;for(var t=this.layers.length-1;0<=t;t--){var e=this.layers[t];(!e.smoothing&&!this.smoothing||e.data.length>this.smoothingMaxSamples)&&(this.isSmooth=!1),e.dirty=!0}if(this.progressive)this.layerFrameRequested||this.renderNextLayer();else{for(;this.renderOneLayer(););this.renderDataLabels()}}renderNextLayer(){this.layerFrameRequested=!1,this.layers&&(this.renderOneLayer()?(this.layerFrameRequested=!0,requestAnimationFrame(this.renderNextLayer.bind(this))):this.renderDataLabels())}renderOneLayer(){var t=this.ctx,e=this.bounds,i=this.layers.filter(function(t){return t.dirty&&!t.hidden}).shift();if(!i)return!1;t.save(),t.scale(this.density,this.density),this.clip&&(t.beginPath(),t.rect(e.x-1,e.y-1,e.width+2,e.height+2),t.clip()),"opacity"in i&&(t.globalAlpha=i.opacity);e="renderLayer";return this[e=(i.smoothing||this.smoothing)&&i.data.length<=this.smoothingMaxSamples?"renderSmoothLayer":e](i),t.restore(),delete i.dirty,!0}renderDataLabels(){var a=this,s=this.ctx,o=this.bounds;this.dataLabels&&this.dataLabels.length&&this.dataLabels.forEach(function(t){var e=t.label,i=a.getDotPos(t);s.save(),s.scale(a.density,a.density),s.font="normal "+a.fontSize+"px "+a.fontFamily,s.textAlign="center",s.textBaseline="middle",s.lineWidth=e.lineWidth||1,s.setLineDash(e.dashStyle||[2,2]),s.strokeStyle=e.strokeStyle||"rgba(128, 128, 128, 0.75)",s.beginPath(),s.moveTo(i.x,o.y),s.lineTo(i.x,o.y+o.height),s.stroke();t=s.measureText(e.text),t={width:a.fontSize+6,height:t.width+10};t.x=i.x-t.width,t.y=o.y,s.setLineDash([]),s.fillStyle=e.color,s.fillRect(t.x,t.y,t.width,t.height),s.strokeRect(t.x,t.y,t.width,t.height),s.fillStyle=e.fontColor||"white",s.translate(t.x+t.width/2,t.y+t.height/2),s.rotate(270*Math.PI/180),s.fillText(e.text,0,0),s.restore()})}renderDataGaps(){var r=this,l=this.bounds,e=this.ctx,n=-1,d=[];this.showDataGaps&&(e.save(),e.scale(r.density,r.density),this.layers.forEach(function(t){if(!t.hidden){var e,i=t.data;if(!(i.length<2))for(var a=1,s=i.length;a<s;a++)e=i[a],(-1==n||e.x-i[a-1].x<n)&&(n=e.x-i[a-1].x)}}),this.layers.forEach(function(t){if(!t.hidden){var e=t.data,i=null;if(!(e.length<2))for(var a,s,o=1,h=e.length;o<h;o++)(i=e[o]).x-e[o-1].x>n&&(a=r.getDotPos(e[o-1]),s=r.getDotPos(i),d.push({x:a.x,y:l.y,width:s.x-a.x,height:l.height}))}}),d.length&&(e.fillStyle=this.gapPattern,d.forEach(function(t){e.fillRect(t.x,t.y,t.width,t.height)})),e.restore())}getDotPos(t){return{x:Math.floor(this.bounds.x+(t.x-this.dataLimits.xMin)/this.dataLimits.width*this.bounds.width),y:Math.floor(this.bounds.y+this.bounds.height-(t.y-this.dataLimits.yMin)/this.dataLimits.height*this.bounds.height)}}renderLayer(t,e){var i=this.ctx,a=t.data,s=t.color,o=this.bounds;i.lineWidth=t.lineWidth||this.lineWidth,i.lineJoin=t.lineJoin||this.lineJoin,i.lineCap=t.lineCap||this.lineCap,i.setLineDash(t.lineDashes||this.lineDashes||[]);var h=("fill"in t?t:this).fill;if(h){i.fillStyle=t.fillStyle||ChartUtils.alphaColor(s,h),i.beginPath(),i.moveTo(o.x,o.y+o.height);for(var r=null,e=0,l=a.length;e<l;e++)r=this.getDotPos(a[e]),i.lineTo(r.x,r.y);i.lineTo(o.x+o.width,o.y+o.height),i.fill()}var n=("stroke"in t?t:this).stroke;n&&(i.strokeStyle=s,i.beginPath());for(var r=null,d=null,e=0,l=a.length;e<l;e++)d=a[e],r=this.getDotPos(d),n&&(0<e?i.lineTo(r.x,r.y):i.moveTo(r.x,r.y)),this.hoverPoints[r.x]=d.x,d.label&&(d.label.color||(d.label.color=s),this.dataLabels.push(d));n&&i.stroke()}renderSmoothLayer(t,e){var i=this.ctx,a=t.data,s=t.color,o=this.bounds,h=this.density;i.lineWidth=t.lineWidth||this.lineWidth,i.lineJoin=t.lineJoin||this.lineJoin,i.lineCap=t.lineCap||this.lineCap,i.setLineDash(t.lineDashes||this.lineDashes||[]);for(var r,l=[],n=[],d=null,e=0,c=a.length;e<c;e++)d=a[e],r=this.getDotPos(d),l.push(r.x),n.push(r.y),this.hoverPoints[r.x]=d.x,d.label&&(d.label.color||(d.label.color=s),this.dataLabels.push(d));var x=ChartUtils.createInterpolant(l,n),y=l[0],f=l[l.length-1],M=0,p=("fill"in t?t:this).fill;if(p){i.fillStyle=t.fillStyle||ChartUtils.alphaColor(s,p),i.beginPath(),i.moveTo(y,o.y+o.height);for(var u=y;u<=f;u+=h)M=x(u),i.lineTo(u,M);i.lineTo(f,M),i.lineTo(f,o.y+o.height),i.fill()}if(("stroke"in t?t:this).stroke){i.strokeStyle=s,i.beginPath();for(u=y;u<=f;u+=1)M=x(u),y<u?i.lineTo(u,M):i.moveTo(u,M);i.stroke()}}update(){this.dirty=!0,ChartManager.check()}setupHover(){var a=this;this.canvas.addEventListener("mouseenter",function(t){document.querySelectorAll(".pxc_tt_overlay").forEach(function(t){t.remove()});var e=a.canvas.getBoundingClientRect(),i=document.createElement("div");i.className="pxc_tt_overlay",i.style.left=Math.floor(e.left+window.scrollX)+"px",i.style.top=Math.floor(e.top+window.scrollY)+"px",i.style.width=e.width+"px",i.style.height=e.height+"px",i.style.cursor=a.cursor,document.body.appendChild(i),i.addEventListener("mousemove",function(t){a.handleHover(t),a.emit("mousemove",t)},!1),i.addEventListener("mouseleave",function(t){a.cancelHover(),i.remove(),a.emit("mouseout",t)},!1),i.addEventListener("mousedown",function(t){a.emit("mousedown",t)},!1),i.addEventListener("mouseup",function(t){a.emit("mouseup",t)},!1),i.addEventListener("click",function(t){a.emit("click",t)},!1),a.emit("mouseover",t)},!1)}redrawTooltip(){this.tooltip&&this.tooltip.lastHoverPt&&(this.tooltip.epoch=0,this.handleHover(this.tooltip.lastHoverPt))}handleHover(t){var o=this,e=this.bounds,i=t.offsetX,a=t.offsetY;if(this.bounds){if(i<e.x-1||i>=e.x+e.width+1||a<e.y||a>=e.y+e.height)return this.cancelHover();var s,h,r=2*e.width,l=0,n=!1;for(h in this.hoverPoints)h=parseInt(h),(s=Math.abs(h-i))<r&&(r=s,l=h,n=this.hoverPoints[h]);if(!n)return this.cancelHover();if(!this.tooltip||this.tooltip.epoch!=n){var d=[];this.layers.forEach(function(t,e){if(!t.hidden)for(var i,a=t.data,s=0,o=a.length;s<o;s++)(i=a[s]).x==n&&(d.push({layer:t,idx:e,row:i,value:i.y}),e=o)});var c="";c+='<div class="pxc_tt_content" style="',c+="font-family:"+this.fontFamily+";",c+="font-size:"+this.fontSize+"px;",c+="color:"+this.fontColor+";",c+="line-height:"+Math.floor(this.fontSize*(4/3))+"px;",c+='">';t=Object.assign({},this.dateStyles.tooltip);"minute"==this.dateRange&&(t.second="2-digit"),c+='<div class="pxc_tt_timestamp">',c+=this.formatDate(n,t),c+="</div>",c+='<table class="pxc_tt_table">',this.hoverSort&&d.sort(function(t,e){return-1==o.hoverSort?e.value-t.value:t.value-e.value}),d.forEach(function(t){var e=t.layer,i=t.value,a=t.row,s=o.formatDataValueForTooltip(i,o.dataType,o.dataSuffix),t=e.color,i="opacity:"+("opacity"in e?e.opacity:1)+";";a.label&&a.label.color&&a.label.tooltip&&(i+="color:"+a.label.color+";"),c+="<tr>",c+='<td><div class="pxc_tt_dot" style="background-color:'+t+"; "+i+'"></div></td>',c+='<td><div class="pxc_tt_title" style="'+i+'">'+e.title+"</div></td>",c+='<td><div class="pxc_tt_value" style="'+i+'">'+s+"</div></td>",c+="</tr>"}),c+="</table>",c+="</div>";var x=this.canvas.getBoundingClientRect();this.tooltip?this.tooltip.epoch=n:(this.tooltip={epoch:n,div:document.createElement("div"),line:document.createElement("div"),points:{}},this.tooltip.div.className="pxc_tooltip"+(this.isSmooth?" pxc_smooth":""),this.tooltip.line.className="pxc_line"+(this.isSmooth?" pxc_smooth":""),this.tooltip.div.style.cursor=this.cursor,this.tooltip.line.style.cursor=this.cursor,document.body.appendChild(this.tooltip.div),document.body.appendChild(this.tooltip.line)),this.tooltip.div.innerHTML=c;var y,t=this.tooltip.div.offsetWidth+20,t=Math.floor(x.left+window.scrollX+ +l-t);for(y in t<0&&(t=Math.floor(x.left+window.scrollX+ +l+20)),this.tooltip.div.style.left=t+"px",this.tooltip.div.style.top=Math.floor(x.top+window.scrollY+(e.y+10))+"px",this.tooltip.line.style.left=Math.floor(x.left+window.scrollX+l)+"px",this.tooltip.line.style.top=Math.floor(x.top+window.scrollY+e.y)+"px",this.tooltip.line.style.height=Math.floor(e.height)+"px",d.forEach(function(t){var e=t.layer,i=o.getDotPos({x:n,y:t.value}),t=o.tooltip.points[e.idx];t||(o.tooltip.points[e.idx]=t=document.createElement("div"),t.className="pxc_tt_point"+(o.isSmooth?" pxc_smooth":""),t.style.backgroundColor=e.color,t.style.cursor=o.cursor,t.style.width=Math.floor(8+o.lineWidth)+"px",t.style.height=Math.floor(8+o.lineWidth)+"px",t.style.borderWidth=Math.floor(o.lineWidth)+"px",e=Math.floor((8+o.lineWidth+2*o.lineWidth)/2),t.style.borderRadius=e+"px",t.style.marginLeft=Math.floor(0-e)+"px",t.style.marginTop=Math.floor(0-e)+"px",document.body.appendChild(t)),t.style.left=Math.floor(x.left+window.scrollX+i.x)+"px",t.style.top=Math.floor(x.top+window.scrollY+i.y)+"px",t._pxc_epoch=n}),this.tooltip.points){var f=this.tooltip.points[y];f._pxc_epoch!=n&&(f.remove(),delete this.tooltip.points[y])}this.tooltip.lastHoverPt={offsetX:i,offsetY:a}}}}cancelHover(){if(this.tooltip){for(var t in this.tooltip.div.remove(),this.tooltip.line.remove(),this.tooltip.points)this.tooltip.points[t].remove();delete this.tooltip}}setupDataGaps(){var t=this,e=new Image;e.onload=function(){t.ready=!0,t.gapPattern=t.ctx.createPattern(e,"repeat")},e.src=this.dataGapImage}formatDataValue(t,e,i){var a=t;switch(e){case"bytes":a=ChartUtils.getTextFromBytes(Math.floor(t),10**(this.floatPrecision-1));break;case"seconds":a=ChartUtils.getTextFromSeconds(t,!0);break;case"milliseconds":a=t<1e3?Math.floor(t)+" ms":ChartUtils.getTextFromSeconds(t/1e3,!0);break;case"integer":a=1e9<=t?Math.floor(t/1e9)+"B":1e6<=t?Math.floor(t/1e6)+"M":1e4<=t?Math.floor(t/1e3)+"K":ChartUtils.numFmt.format(Math.floor(t));break;case"string":a=t;break;default:a=""+ChartUtils.shortFloat(a,this.floatPrecision)}return i&&(a+=i),a}formatDataValueForTooltip(t,e,i){var a=t;switch(e){case"bytes":a=ChartUtils.getTextFromBytes(Math.floor(t),10**this.floatPrecision);break;case"seconds":a=ChartUtils.getTextFromSeconds(t,!1);break;case"milliseconds":a=t<1e3?ChartUtils.shortFloat(a,this.floatPrecision)+" ms":ChartUtils.getTextFromSeconds(t/1e3,!1);break;case"integer":a=ChartUtils.numFmt.format(Math.floor(t));break;case"string":a=t;break;default:a=""+ChartUtils.shortFloat(a,this.floatPrecision)}return i&&(a+=i),a}formatDate(t,e){e="object"==typeof e?e:this.dateStyles[e];return e.timeZone=this.timeZone,new Date(1e3*t).toLocaleString(this.locale,e)}isVisible(){if(this.hidden)return!1;if(!this.canvas)return!1;var t=this.canvas.getBoundingClientRect();return 0!=t.width&&(0!=t.height&&(!(t.right<0)&&(!(t.left>=window.innerWidth)&&(!(t.bottom<0)&&!(t.top>=window.innerHeight)))))}snapshot(t,e){var i=(t.format||"image/png").toLowerCase();i.match(/^\w+$/)&&(i="image/"+i),delete t.format;var a=t.quality||1;delete t.quality;var s=t.type||"blob";if(delete t.type,0==Object.keys(t).length){if("url"!=s)return void this.canvas.toBlob(function(t){e(t)},i,a);var o=this.canvas.toDataURL(i,a);return e&&e(o),o}t.autoResize=!1,t.autoManage=!1,t.hover=!1,t.progressive=!1,t.canvas=document.createElement("canvas"),t.width||(t.width=this.canvas.offsetWidth),t.height||(t.height=this.canvas.offsetHeight);var h=this.clone(t);if(h.render(),"url"==s){o=h.canvas.toDataURL(i,a);return h.destroy(),e&&e(o),o}h.canvas.toBlob(function(t){h.destroy(),e(t)},i,a)}download(t={}){var e;t.filename||(e=(t.format||"png").replace(/^image\//,"").toLowerCase(),t.filename=this.title.replace(/[^\w\-\.]+/g,"")+"."+e);var i=t.filename;delete t.filename,t.type="blob",this.snapshot(t,function(t){var e=URL.createObjectURL(t),t=document.createElement("a");t.style.display="none",t.setAttribute("href",e),t.setAttribute("download",i),document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(e)})}destroy(){this.cancelHover(),this.observer&&this.observer.disconnect(),delete this.observer,delete this.ctx,delete this.canvas,delete this.layers,delete this.dirty,delete this.layerFrameRequested,this.manager&&this.manager.remove(this),document.querySelectorAll(".pxc_tt_overlay").forEach(function(t){t.remove()})}on(t,e){t in this.events||(this.events[t]=[]),this.events[t].push(e)}off(t,e){t in this.events&&(-1<(e=this.events[t].indexOf(e))&&this.events[t].splice(e,1),0===this.events[t].length&&delete this.events[t])}emit(t,...e){t in this.events&&this.events[t].forEach(function(t){t(...e)})}}const ChartManager={charts:[],inited:!1,add(t){t.idx=this.charts.length,(t.manager=this).charts.push(t)},remove(t){this.charts.splice(t.idx,1),this.charts.forEach(function(t,e){t.idx=e})},init(){this.inited||(window.addEventListener("scroll",ChartUtils.debounce(this.check.bind(this),100),!1),window.addEventListener("resize",ChartUtils.debounce(this.check.bind(this),100),!1),setInterval(this.check.bind(this),250),this.inited=!0)},check(){var t=this.charts.filter(function(t){return t.dirty&&t.isVisible()}).shift();t&&(t.render(),requestAnimationFrame(this.check.bind(this)))}},ChartUtils={numFmt:new Intl.NumberFormat,getTextFromSeconds(t,e){var i="";t<0&&(t=-t,i="-");var a=e?"sec":"second",s=t;59<t&&(a=e?"min":"minute",59<(s=t=t/60)&&(a=e?"hr":"hour",23<(s=t=t/60)&&(a="day",s=t/24)));a=(s=s<10?Math.floor(10*s)/10:Math.floor(s))+" "+a;return 1==s||e||(a+="s"),i+a},getTextFromBytes(t,e){return e=e||10,1024<=(t=Math.floor(t))?1024<=(t=Math.floor(t/1024*e)/e)?1024<=(t=Math.floor(t/1024*e)/e)?1024<=(t=Math.floor(t/1024*e)/e)?(t=Math.floor(t/1024*e)/e)+" TB":t+" GB":t+" MB":t+" K":t+" B"},shortFloat(t,e){e=e||2;e=Math.pow(10,e);return(t=Math.floor(parseFloat(t||0)*e)/e)==Math.floor(t)&&(t+=".0"),""+t},alphaColor(t,e){var i=t.match(/(\w{2})(\w{2})(\w{2})/);return i?"rgba("+parseInt(i[1],16)+", "+parseInt(i[2],16)+", "+parseInt(i[3],16)+", "+e+")":(i=t.match(/^(\w+)\D+(\d+)\D+(\d+)\D+(\d+)/))?i[1]+"("+i[2]+", "+i[3]+", "+i[4]+", "+e+")":"rgb(0,0,0)"},debounce(i,a){var s=null,o=!1;return function(){var t=this,e=arguments;o=!!s||(i.apply(t,e),s=setTimeout(function(){s=null,o&&(i.apply(t,e),o=!1)},a),!1)}},createInterpolant(l,n){var t=l.length;if(t!=n.length)throw"Need an equal count of xs and ys.";if(0===t)return function(t){return 0};if(1===t){var e=+n[0];return function(t){return e}}for(var i=[],a=[],s=[],o=0;o<t-1;o++){var h=l[o+1]-l[o],r=n[o+1]-n[o];a.push(h),i.push(r),s.push(r/h)}var d=[s[0]];for(o=0;o<a.length-1;o++){var c,x,y,f=s[o],M=s[o+1];f*M<=0?d.push(0):(c=a[o],x=a[o+1],d.push(3*(y=c+x)/((y+x)/f+(y+c)/M)))}d.push(s[s.length-1]);var p=[],u=[];for(o=0;o<d.length-1;o++){var v=d[o],g=s[o],m=1/a[o],b=v+d[o+1]-g-g;p.push((g-v-b)*m),u.push(b*m*m)}return function(t){var e=l.length-1;if(t==l[e])return n[e];for(var i=0,a=u.length-1;i<=a;){var s=Math.floor(.5*(i+a)),o=l[s];if(o<t)i=s+1;else{if(!(t<o))return n[s];a=s-1}}var e=Math.max(0,a),h=t-l[e],r=h*h;return n[e]+d[e]*h+p[e]*r+u[e]*h*r}}};!function(){var t=document.createElement("style");t.innerHTML=".pxc_tt_overlay{position:absolute;z-index:2}.pxc_tooltip,.pxc_line,.pxc_tt_point{position:absolute;z-index:1}.pxc_smooth{transition:all .1s ease-in-out}.pxc_line{width:0;border-left:1px dashed #ccc}.pxc_tt_content{display:inline-block;background-color:rgba(255,255,255,1.0);border:1px solid #ddd;border-radius:5px;box-shadow:2px 2px 6px rgba(0,0,0,0.1)}.pxc_tt_timestamp{padding:5px 8px 4px 8px;background-color:#efefef;border-bottom:1px solid #ddd;border-top-left-radius:5px;border-top-right-radius:5px}.pxc_tt_table{margin:5px 6px 5px 6px}.pxc_tt_dot{width:10px;height:10px;border-radius:5px;margin-top:0}.pxc_tt_title{font-weight:bold}.pxc_tt_value{margin-left:10px;text-align:right}.pxc_tt_point{box-sizing:content-box !important;border-color:#fff;border-style:solid}body.dark .pxc_line{border-left:1px dashed #444}body.dark .pxc_tt_content{background-color:rgba(0,0,0,1.0);border:1px solid #333;box-shadow:none}body.dark .pxc_tt_timestamp{background-color:#222;border-bottom:1px solid #333}body.dark .pxc_tt_point{border-color:#000}",document.head.appendChild(t)}();

    const relayState = document.getElementById('relayState');
    relayState.onanimationend = () => setRelayState();
    setTimeout(fetchState, 1000); // updateRelayState at page load
    setInterval(fetchState, 10000); // updateRelayState every 10s, relay can be switched elsewhere
    var skipChartUpdate = 5;

    function openConfigModal()
    {
        document.getElementById('configModal').style.display = 'block';
    };
    function closeConfigModal()
    {
        document.getElementById('configModal').style.display = 'none';
        fetchState();
    }
    function showNotify(notifyText)
    {
        document.getElementById('alertMsg').textContent = notifyText;
        document.getElementById('alert').style.display = 'block';
        setTimeout(function() { document.getElementById('alert').style.display = 'none'; }, 5000);
    }

    function fetchState()
    {
        fetch('/ctl').then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.json();
        }).then(data => {
            const timeNow = new Date(data.timeNow*1000);
            document.getElementById('controllerTime').innerHTML = '<span>' + timeNow.toLocaleString('sv-SE') + '</span>';
            document.getElementById('chargerLimits').innerHTML =
                data.limitsActive == 1 ? 'Limits active. Uset=<span>' + data.dcVoltageSet/100 + '</span>V, Iset=<span>' + data.dcCurrentSet/10 + '</span>A.' : '';
            // float to int 1395/60=23,25 (23,25>>0)=23
            document.getElementById('chargerTurnOnTime').textContent = ((data.relayTurnOnTime/60)>>0) + ':' + data.relayTurnOnTime%60;
            document.getElementById('chargerTurnOffTime').textContent = ((data.relayTurnOffTime/60)>>0) + ':' + data.relayTurnOffTime%60;
            if ( data.relayState == 1 )
            {
                relayState.className = 'buttonOff';
                relayState.textContent = 'Turn off AC mains';
            } else {
                relayState.className = 'buttonOn';
                relayState.textContent = 'Turn on AC mains';
            }
            for (let i = 0; i < data.chargers.length; i++)
            {
                document.getElementById('container' + i).style.display = 'table';
                document.getElementById('chargerSN' + i).textContent =         data.chargers[i].serial;
                document.getElementById('chargerStatus' + i).textContent =     data.chargers[i].status;
                document.getElementById('chargerAlarms' + i).textContent =     data.chargers[i].alarms;
                document.getElementById('chargerWarnings' + i).textContent =   data.chargers[i].warnings;
                document.getElementById('chargerInTemp' + i).textContent =     data.chargers[i].inletTemperature;
                document.getElementById('chargerOutTemp' + i).textContent =    data.chargers[i].outletTemperature;
                document.getElementById('acVoltage' + i).textContent =         data.chargers[i].acVoltage;
                document.getElementById('dcVoltage' + i).textContent =         data.chargers[i].dcVoltage / 100;
                document.getElementById('dcCurrent' + i).textContent =         data.chargers[i].dcCurrent / 10;
                document.getElementById('chargerName' + i).textContent =       data.chargers[i].name;
                document.getElementById('chargerHWVer' + i).textContent =      data.chargers[i].hardwareVersion;
                document.getElementById('chargerHWVer' + i).title =            data.chargers[i].partNumber;
                document.getElementById('chargerSWVer' + i).textContent =      data.chargers[i].primarySoftwareVersion;
                document.getElementById('chargerSWVer' + i).title =            data.chargers[i].primarySoftwarePartnumber;
                document.getElementById('chargerSWVerSpare' + i).textContent = data.chargers[i].secondarySoftwareVersion;
                document.getElementById('chargerSWVerSpare' + i).title =       data.chargers[i].secondarySoftwarePartnumber;
                // function call via timer with interval 10s. chart update interval 60s
                skipChartUpdate++;
                if (skipChartUpdate > 5)
                {
                    skipChartUpdate = 0;
                    chartUpdate(i, data.chargers[i].serial);
                }
            }
        }).catch(error => {
            showNotify(error);
        });

        fetch('/log').then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(data => {
            document.getElementById('log').textContent = data.split('\n').reverse().join('\n');
        }).catch(error => {
            showNotify(error);
        });
    }

    function chartUpdate(i, chargerSN)
    {
        const chartParams={
            'canvas': '#charger' + i,
            'fill': false,
            'title': 'Charger ID:  SN: ',
            'dataType': 'float',
            'horizTicks': 24,
            'dateStyles' : {
                minute: { hour: 'numeric', hour12: false, minute: '2-digit', second: '2-digit' },
                hour:   { hour: 'numeric', hour12: false, minute: '2-digit' },
                day:    { hour: 'numeric', hour12: false, minute: '2-digit' },
                month:  { month: 'short', day: 'numeric' },
                year:   { month: 'short' },
                tooltip: { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', hour12: false, minute: '2-digit' }
            }
        }

        fetch('/chart?charger=' + chargerSN).then(
            response => {
                if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
                return response.arrayBuffer();
            }
        ).then(
            data => {
                let dataView = new DataView(data);
                var chart = new Chart(chartParams);

                chart.title = 'Charger ID: ' + (i+1) + ' SN: ' + chargerSN;

                const STATUS_STRUCT_SIZE = 10

                var rows = [];
                for (let i = 0; i < dataView.byteLength / STATUS_STRUCT_SIZE; i++)
                    rows.push({ x: dataView.getUint32(i*STATUS_STRUCT_SIZE, true), y: dataView.getUint8(i*STATUS_STRUCT_SIZE+4, true) });
                chart.addLayer({ title: 'Temperature at cooler', data: rows, color: '#A1F464' });

                rows = [];
                for (let i = 0; i < dataView.byteLength / STATUS_STRUCT_SIZE; i++)
                    rows.push({ x: dataView.getUint32(i*STATUS_STRUCT_SIZE, true), y: dataView.getUint8(i*STATUS_STRUCT_SIZE+9, true) });
                chart.addLayer({ title: 'Temperature at connector', data: rows, color: '#C7F434' });

                rows = [];
                for (let i = 0; i < dataView.byteLength / STATUS_STRUCT_SIZE; i++)
                    rows.push({ x: dataView.getUint32(i*STATUS_STRUCT_SIZE, true), y: dataView.getUint16(i*STATUS_STRUCT_SIZE+5, true) / 10 });
                chart.addLayer({ title: 'DC current', data: rows, color: '#FF4560', lineWidth: 3 });

                rows = [];
                for (let i = 0; i < dataView.byteLength / STATUS_STRUCT_SIZE; i++)
                    rows.push({ x: dataView.getUint32(i*STATUS_STRUCT_SIZE, true), y: dataView.getUint16(i*STATUS_STRUCT_SIZE+7, true) / 100 });
                chart.addLayer({ title: 'DC voltage', data: rows, color: '#008FFB', lineWidth: 3 });

                chart.render();
            }
        ).catch(error => {
            showNotify(error);
        });
    }

    function setRelayState()
    {
        let relaySetStateUri = relayState.className === 'buttonOn' ? '/ctl?relay=1' : '/ctl?relay=0';
        fetch(relaySetStateUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
            fetchState();
        }).catch(error => {
            showNotify(error);
        });
    }

    function temporarilyBlockConfButtons()
    {
        const elements = document.getElementsByClassName("confButton");
        for (let i = 0; i < elements.length; i++) {
            elements[i].disabled = true;
            setTimeout(function() { elements[i].disabled = false; }, 5000);
        }
    }

    function applyLimits()
    {
        temporarilyBlockConfButtons();
        let limitsApplyUri = document.getElementById('applyLimits').checked ? '/ctl?limits=1' : '/ctl?limits=0';
        fetch(limitsApplyUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }

    function setCurrentLimit()
    {
        temporarilyBlockConfButtons();
        const currentValue = document.getElementById('dcCurrent').value * 10;
        if ( isNaN(currentValue) || currentValue < 100 || currentValue > 375 )
        {
            showNotify("The specified current value is out of range (10.0A - 37.4A)");
            return;
        }
        let setCurrentLimitUri = '/ctl?currentLimit=' + currentValue;
        fetch(setCurrentLimitUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }

    function setVoltageLimit()
    {
        temporarilyBlockConfButtons();
        const voltageValue = document.getElementById('dcVoltage').value * 100;
        if ( isNaN(voltageValue) || voltageValue < 4159 || voltageValue > 5821 )
        {
            showNotify("The specified voltage value is out of range (41.60V - 58.20V)");
            return;
        }
        let setVoltageLimitUri = '/ctl?voltageLimit=' + voltageValue;
        fetch(setVoltageLimitUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }

    function setRelayTurnOnTime()
    {
        temporarilyBlockConfButtons();
        const timeArray = document.getElementById('turnOnTime').value.split(':');
        const timeValue = timeArray[0] * 60 + timeArray[1] * 1;

        if ( timeArray.length != 2 || timeArray[0] > 23 || timeArray[1] > 59 || timeArray[0] < 0 || timeArray[1] < 0 ||
             isNaN(timeValue)  || timeValue < 1 || timeValue >= 24*60 )
        {
            showNotify("The specified time is invalid");
            return;
        }
        let relayTurnOnTimeUri = '/ctl?relayTurnOnTime=' + timeValue;
        fetch(relayTurnOnTimeUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }


    function setRelayTurnOffTime()
    {
        temporarilyBlockConfButtons();
        const timeArray = document.getElementById('turnOffTime').value.split(':');
        const timeValue = timeArray[0] * 60 + timeArray[1] * 1;

        if ( timeArray.length != 2 || timeArray[0] > 23 || timeArray[1] > 59 || timeArray[0] < 0 || timeArray[1] < 0 ||
             isNaN(timeValue)  || timeValue < 1 || timeValue >= 24*60 )
        {
            showNotify("The specified time is invalid");
            return;
        }
        let relayTurnOffTimeUri = '/ctl?relayTurnOffTime=' + timeValue;
        fetch(relayTurnOffTimeUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }

    function setDefaultVoltage()
    {
        temporarilyBlockConfButtons();
        const voltageValue = document.getElementById('dcVoltageDefault').value * 100;
        if ( isNaN(voltageValue) || voltageValue < 4159 || voltageValue > 5821 )
        {
            showNotify("The specified voltage value is out of range (41.60V - 58.20V)");
            return;
        }
        let defaultVoltageSetUri = '/ctl?defaultVoltageSet=' + voltageValue;
        fetch(defaultVoltageSetUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }

    function storeConfigToNVS()
    {
        temporarilyBlockConfButtons();
        let storeConfigToNVSUri = '/ctl?storeConfigToNVS=1';
        fetch(storeConfigToNVSUri).then(response => {
            if (!response.ok) { showNotify(`HTTP error, status = ${response.status} ${response.body}`); }
            return response.text();
        }).then(body => {
            showNotify(body);
        }).catch(error => {
            showNotify(error);
        });
    }
</script>

</html>
